#!/usr/bin/env expect
set timeout 5
set lib [file normalize [file dirname [info script]]/fail_strdup_count.so]
if {[catch {exec cc -shared -fPIC -O2 -o $lib [file dirname [info script]]/fail_strdup_count.c}]} {
    send_user "compile failed\n"
    exit 1
}
set env(LD_PRELOAD) $lib
set env(FAIL_STRDUP_AT) 23
spawn [file dirname [info script]]/../vush
expect {
    "vush> " {}
    timeout { send_user "prompt timeout\n"; exit 1 }
}
send "foo() { echo hi; }\r"
expect {
    "vush> " {}
    timeout { send_user "def timeout\n"; exit 1 }
}
send "foo\r"
expect {
    "vush> " {}
    eof { send_user "shell crashed\n"; exit 1 }
    timeout { send_user "call timeout\n"; exit 1 }
}
send "exit\r"
expect {
    eof {}
    timeout { send_user "exit timeout\n"; exit 1 }
}
