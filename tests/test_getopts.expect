#!/usr/bin/expect -f
set timeout 5
set script [exec mktemp]
set f [open $script "w"]
puts $f "while getopts \"ab:\" o; do echo \"$o:$OPTARG\"; done; echo index:$OPTIND"
close $f
spawn ../vush $script -a -b foo rest
expect {
    -re "a:[\r\n]+b:foo[\r\n]+index:4[\r\n]+" {}
    timeout { send_user "getopts parsing failed\n"; exec rm $script; exit 1 }
}
expect eof
spawn ../vush $script -z
expect {
    -re "getopts: illegal option -- z[\r\n]+\?:[\r\n]+index:2[\r\n]+" {}
    timeout { send_user "invalid option not handled\n"; exec rm $script; exit 1 }
}
expect eof
spawn ../vush $script -b
expect {
    -re "getopts: option requires an argument -- b[\r\n]+\?:[\r\n]+index:2[\r\n]+" {}
    timeout { send_user "missing argument not detected\n"; exec rm $script; exit 1 }
}
expect eof
exec rm $script
